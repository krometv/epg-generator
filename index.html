<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML EPG Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .content {
            padding: 20px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            min-height: 150px;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }
        
        #xmlOutput {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow: auto;
            white-space: pre;
        }
        
        #status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        #status.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }
        
        #status.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }
        
        #status.info {
            display: block;
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .button-row {
            margin-top: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .stat-card h4 {
            color: #667eea;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ XML EPG Generator</h1>
            <p>Generate Electronic Program Guide XML</p>
        </div>
        
        <div class="content">
            <div id="status"></div>
            
            <div class="control-group">
                <h3>üìù Event Input</h3>
                <textarea id="eventInput" placeholder="Enter events in either format:
Format 1: Channel ID :Event Name @ Sep 22 7:00 PM
Format 2: Channel ID - Event Name 2025-09-22 19:30

Examples:
MLB 01 :Yankees vs Red Sox @ Sep 22 7:00 PM
FloSports 3 - Balmoral Hall vs SAHA 2025-09-22 11:30"></textarea>
                <div class="button-row">
                    <button class="btn-success" onclick="addEvents()">Add Events to EPG</button>
                    <button class="btn-secondary" onclick="document.getElementById('eventInput').value='';showMsg('Input cleared','info')">Clear Input</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>üõ†Ô∏è EPG Management</h3>
                <div class="button-row">
                    <button onclick="initChannels()">Initialize Channels</button>
                    <button class="btn-warning" onclick="loadFromGitHub()">Load from GitHub</button>
                    <button class="btn-info" onclick="purgeOld()">Purge Old (7+ days)</button>
                    <button class="btn-danger" onclick="clearAllData()">Clear All</button>
                    <button class="btn-secondary" onclick="showStats()">Show Stats</button>
                </div>
                <div id="stats" class="stats" style="display:none"></div>
            </div>
            
            <div class="control-group">
                <h3>üíæ Save Options</h3>
                <input type="password" id="githubToken" placeholder="GitHub Token (saved locally)">
                <div class="button-row">
                    <button class="btn-info" onclick="saveToken()">Save Token</button>
                    <button class="btn-success" onclick="saveToGitHub()">Save to GitHub</button>
                    <button class="btn-warning" onclick="downloadXML()">Download XML</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>XML Output:</h3>
                <div id="xmlOutput">No EPG generated yet. Click "Initialize Channels" to start.</div>
            </div>
        </div>
    </div>

<script>
// Global EPG data
var currentEPG = null;
var GITHUB_REPO = 'krometv/epg-generator'; // UPDATE THIS to your repo name
var GITHUB_FILE = 'KTV_EPG_Events-all.xml';

// Channel list with proper spacing
var channels = [
    { prefix: 'MLB ', count: 30 },
    { prefix: 'Peacock Event ', count: 100 },
    { prefix: 'NFL Game Pass ', count: 30 },
    { prefix: 'VIX+ ', count: 10 },
    { prefix: 'BTN+ ', count: 100 },
    { prefix: 'Paramount+ ', count: 100 },
    { prefix: 'Stan Sports ', count: 81 },
    { prefix: 'Milb ', count: 300 },
    { prefix: 'ESPN+ ', count: 300 },
    { prefix: 'Flo Wrestling ', count: 100 },
    { prefix: 'Flo Hockey ', count: 300 },
    { prefix: 'NHL ', count: 30 },
    { prefix: 'Flo Baseball ', count: 100 },
    { prefix: 'Flo Football ', count: 100 },
    { prefix: 'Flo College ', count: 300 },
    { prefix: 'Flo Racing ', count: 50 },
    { prefix: 'TSN+ ', count: 100 },
    { prefix: 'WNBA ', count: 30 },
    { prefix: 'Tennis ', count: 150 },
    { prefix: 'MAX US', count: 300 }, // No space
    { prefix: 'UEFA ', count: 20 },
    { prefix: 'Clubber Event ', count: 89 },
    { prefix: 'MLS ', count: 60 },
    { prefix: 'EFL', count: 40 }, // No space
    { prefix: 'PPV ', count: 120 },
    { prefix: 'Dirtvision ', count: 10 }
];

// Load token on start
window.onload = function() {
    var token = localStorage.getItem('githubToken');
    if (token) {
        document.getElementById('githubToken').value = token;
    }
    showMsg('Ready to use!', 'info');
};

// Show message
function showMsg(msg, type) {
    var status = document.getElementById('status');
    status.textContent = msg;
    status.className = type;
    setTimeout(function() {
        status.style.display = 'none';
    }, 5000);
}

// Format date for XML
function formatDate(date) {
    var y = date.getFullYear();
    var m = ('0' + (date.getMonth() + 1)).slice(-2);
    var d = ('0' + date.getDate()).slice(-2);
    var h = ('0' + date.getHours()).slice(-2);
    var min = ('0' + date.getMinutes()).slice(-2);
    var s = ('0' + date.getSeconds()).slice(-2);
    return y + m + d + h + min + s + ' +0000';
}

// Parse date
function parseDate(str) {
    // Try 2025-09-22 19:30
    var m = str.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})/);
    if (m) {
        return new Date(m[1], m[2]-1, m[3], m[4], m[5]);
    }
    
    // Try Sep 22 7:00 PM
    var months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    m = str.match(/(\w+)\s+(\d+)\s+(\d+):(\d+)\s*(AM|PM)/i);
    if (m) {
        var hour = parseInt(m[3]);
        if (m[5].toUpperCase() === 'PM' && hour !== 12) hour += 12;
        if (m[5].toUpperCase() === 'AM' && hour === 12) hour = 0;
        return new Date(new Date().getFullYear(), months[m[1]], parseInt(m[2]), hour, parseInt(m[4]));
    }
    
    return null;
}

// Initialize channels
function initChannels() {
    if (currentEPG && !confirm('Replace all data with fresh channels?')) return;
    
    var progs = [];
    var now = new Date();
    
    channels.forEach(function(ch) {
        for (var i = 1; i <= ch.count; i++) {
            var num = ('0' + i).slice(-2);
            var displayName = ch.prefix + num;
            var xmlId = displayName.replace(/\s+/g, '');
            
            progs.push({
                channel: xmlId,
                displayName: displayName,
                start: formatDate(now),
                stop: formatDate(new Date(now.getTime() + 3600000)),
                title: 'Channel Placeholder',
                desc: 'Placeholder for ' + displayName
            });
        }
    });
    
    currentEPG = buildXML(progs);
    document.getElementById('xmlOutput').textContent = currentEPG;
    showMsg('Initialized ' + progs.length + ' channels!', 'success');
}

// Build XML
function buildXML(progs) {
    var xml = '<?xml version="1.0" encoding="UTF-8"?>\n<tv>\n';
    
    // Get unique channels
    var chans = {};
    progs.forEach(function(p) {
        if (!chans[p.channel]) {
            chans[p.channel] = p.displayName || p.channel;
        }
    });
    
    // Add channels
    Object.keys(chans).sort().forEach(function(id) {
        xml += '  <channel id="' + id + '">\n';
        xml += '    <display-name>' + chans[id] + '</display-name>\n';
        xml += '  </channel>\n';
    });
    
    // Add programmes
    progs.sort(function(a,b) {
        if (a.channel !== b.channel) return a.channel.localeCompare(b.channel);
        return a.start.localeCompare(b.start);
    });
    
    progs.forEach(function(p) {
        xml += '  <programme channel="' + p.channel + '" start="' + p.start + '" stop="' + p.stop + '">\n';
        xml += '    <title>' + escapeXML(p.title) + '</title>\n';
        xml += '    <desc>' + escapeXML(p.desc) + '</desc>\n';
        xml += '  </programme>\n';
    });
    
    xml += '</tv>';
    return xml;
}

// Escape XML
function escapeXML(str) {
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&apos;');
}

// Parse existing EPG
function parseEPG(xml) {
    var progs = [];
    var parser = new DOMParser();
    var doc = parser.parseFromString(xml, 'text/xml');
    
    // Get display names
    var names = {};
    var chans = doc.getElementsByTagName('channel');
    for (var i = 0; i < chans.length; i++) {
        var id = chans[i].getAttribute('id');
        var dn = chans[i].getElementsByTagName('display-name')[0];
        if (dn) names[id] = dn.textContent;
    }
    
    // Get programmes
    var ps = doc.getElementsByTagName('programme');
    for (var i = 0; i < ps.length; i++) {
        var ch = ps[i].getAttribute('channel');
        var t = ps[i].getElementsByTagName('title')[0];
        var d = ps[i].getElementsByTagName('desc')[0];
        progs.push({
            channel: ch,
            displayName: names[ch] || ch,
            start: ps[i].getAttribute('start'),
            stop: ps[i].getAttribute('stop'),
            title: t ? t.textContent : '',
            desc: d ? d.textContent : ''
        });
    }
    
    return progs;
}

// Add events
function addEvents() {
    var input = document.getElementById('eventInput').value.trim();
    if (!input) {
        showMsg('Enter some events first', 'error');
        return;
    }
    
    var progs = currentEPG ? parseEPG(currentEPG) : [];
    var lines = input.split('\n');
    var added = 0;
    
    lines.forEach(function(line) {
        line = line.trim();
        if (!line) return;
        
        // Try format: Channel - Event 2025-09-22 19:30
        var m = line.match(/^(.+?)\s*-\s*(.+?)\s+(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})$/);
        
        // Try format: Channel :Event @ Date
        if (!m) {
            m = line.match(/^(.+?)\s*:\s*(.+?)\s*@\s*(.+)$/);
        }
        
        if (m) {
            var channel = m[1].trim();
            var event = m[2].trim();
            var eventTime = parseDate(m[3].trim());
            
            if (eventTime) {
                var xmlId = channel.replace(/\s+/g, '');
                var isRacing = channel.toLowerCase().includes('racing');
                
                // 8hr before
                var t1 = new Date(eventTime.getTime() - 8.5*3600000);
                var t2 = new Date(eventTime.getTime() - 0.5*3600000);
                progs.push({
                    channel: xmlId,
                    displayName: channel,
                    start: formatDate(t1),
                    stop: formatDate(t2),
                    title: 'Event Later Today - ' + event,
                    desc: 'Upcoming: ' + event
                });
                
                // Warmup
                var t3 = new Date(eventTime.getTime() - 0.5*3600000);
                progs.push({
                    channel: xmlId,
                    displayName: channel,
                    start: formatDate(t3),
                    stop: formatDate(eventTime),
                    title: isRacing ? 'Engines Starting, Race Starting Soon' : 'Players Warming Up',
                    desc: 'Pre-game for ' + event
                });
                
                // Main event
                var t4 = new Date(eventTime.getTime() + 3.5*3600000);
                progs.push({
                    channel: xmlId,
                    displayName: channel,
                    start: formatDate(eventTime),
                    stop: formatDate(t4),
                    title: 'Live: ' + event,
                    desc: 'Live coverage of ' + event
                });
                
                added += 3;
            }
        }
    });
    
    if (added > 0) {
        currentEPG = buildXML(progs);
        document.getElementById('xmlOutput').textContent = currentEPG;
        showMsg('Added ' + added + ' programmes! Total: ' + progs.length, 'success');
    } else {
        showMsg('No events added. Check format.', 'error');
    }
}

// Clear all data
function clearAllData() {
    if (!confirm('This will clear ALL EPG data. Are you sure?')) {
        return;
    }
    
    // Force clear everything
    currentEPG = null;
    
    // Clear the display
    var output = document.getElementById('xmlOutput');
    output.textContent = 'No EPG generated yet. Click "Initialize Channels" to start.';
    
    // Clear input field
    var input = document.getElementById('eventInput');
    if (input) {
        input.value = '';
    }
    
    // Hide stats if shown
    var stats = document.getElementById('stats');
    if (stats) {
        stats.style.display = 'none';
        stats.innerHTML = '';
    }
    
    showMsg('All data has been cleared!', 'success');
}

// Load from GitHub
async function loadFromGitHub() {
    try {
        showMsg('Loading from GitHub...', 'info');
        var resp = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/contents/' + GITHUB_FILE);
        if (resp.ok) {
            var data = await resp.json();
            currentEPG = atob(data.content);
            document.getElementById('xmlOutput').textContent = currentEPG;
            var progs = parseEPG(currentEPG);
            showMsg('Loaded ' + progs.length + ' programmes!', 'success');
        } else {
            showMsg('No file found on GitHub', 'error');
        }
    } catch(e) {
        showMsg('Error: ' + e.message, 'error');
    }
}

// Purge old
function purgeOld() {
    if (!currentEPG) {
        showMsg('No data', 'error');
        return;
    }
    if (!confirm('Remove programmes older than 7 days?')) return;
    
    var progs = parseEPG(currentEPG);
    var cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 7);
    
    var before = progs.length;
    progs = progs.filter(function(p) {
        var date = new Date(p.stop.slice(0,4), p.stop.slice(4,6)-1, p.stop.slice(6,8));
        return date > cutoff;
    });
    
    currentEPG = buildXML(progs);
    document.getElementById('xmlOutput').textContent = currentEPG;
    showMsg('Removed ' + (before - progs.length) + ' old programmes', 'success');
}

// Show stats
function showStats() {
    if (!currentEPG) {
        showMsg('No data', 'error');
        return;
    }
    
    var progs = parseEPG(currentEPG);
    var chans = new Set(progs.map(function(p) { return p.channel; }));
    
    var stats = document.getElementById('stats');
    stats.innerHTML = '<div class="stat-card"><h4>Channels</h4><p>' + chans.size + '</p></div>' +
                     '<div class="stat-card"><h4>Total</h4><p>' + progs.length + '</p></div>';
    stats.style.display = 'grid';
}

// Save token
function saveToken() {
    var token = document.getElementById('githubToken').value.trim();
    if (token) {
        localStorage.setItem('githubToken', token);
        showMsg('Token saved!', 'success');
    } else {
        localStorage.removeItem('githubToken');
        showMsg('Token cleared', 'info');
    }
}

// Save to GitHub
async function saveToGitHub() {
    try {
        var token = document.getElementById('githubToken').value.trim();
        if (!token) {
            showMsg('Enter GitHub token first', 'error');
            return;
        }
        if (!currentEPG) {
            showMsg('No EPG to save', 'error');
            return;
        }
        
        showMsg('Saving...', 'info');
        
        // Get SHA if exists
        var sha = null;
        try {
            var resp = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
                headers: { 'Authorization': 'token ' + token }
            });
            if (resp.ok) {
                var data = await resp.json();
                sha = data.sha;
            }
        } catch(e) {}
        
        // Save
        var body = {
            message: 'Update EPG',
            content: btoa(currentEPG)
        };
        if (sha) body.sha = sha;
        
        resp = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/contents/' + GITHUB_FILE, {
            method: 'PUT',
            headers: {
                'Authorization': 'token ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        
        if (resp.ok) {
            showMsg('Saved to GitHub!', 'success');
        } else {
            showMsg('Save failed', 'error');
        }
    } catch(e) {
        showMsg('Error: ' + e.message, 'error');
    }
}

// Download XML
function downloadXML() {
    if (!currentEPG) {
        showMsg('No EPG to download', 'error');
        return;
    }
    
    var blob = new Blob([currentEPG], {type: 'text/xml'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'KTV_EPG_Events-all.xml';
    a.click();
    showMsg('Downloaded!', 'success');
}
</script>
</body>
</html>
